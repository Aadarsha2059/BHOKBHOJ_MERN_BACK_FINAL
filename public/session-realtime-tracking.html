<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Session Activity Tracking - White Box Testing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background: #48bb78;
        }
        
        .status-indicator.disconnected {
            background: #fc8181;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.8em;
        }
        
        .session-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .session-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .session-card.activity-updated::before {
            left: 100%;
        }
        
        .session-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .session-card.current {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .session-card.expiring {
            border-color: #f6ad55;
            background: #fffaf0;
        }
        
        .session-card.expired {
            border-color: #fc8181;
            background: #fff5f5;
            opacity: 0.7;
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .device-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .device-icon {
            font-size: 2.5em;
        }
        
        .device-details h3 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .device-details p {
            color: #666;
            font-size: 0.9em;
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-current {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .badge-active {
            background: #bee3f8;
            color: #2c5282;
        }
        
        .badge-expired {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .badge-updated {
            background: #fef5e7;
            color: #d68910;
            animation: flash 0.5s;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .session-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .detail-value {
            color: #333;
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }
        
        .detail-value.updated {
            color: #d68910;
            font-weight: bold;
            animation: highlight 1s;
        }
        
        @keyframes highlight {
            0%, 100% { background: transparent; }
            50% { background: #fef5e7; }
        }
        
        .timeout-bar {
            background: #e2e8f0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 10px;
            position: relative;
        }
        
        .timeout-progress {
            height: 100%;
            transition: width 1s linear, background 0.3s;
            border-radius: 6px;
        }
        
        .timeout-progress.safe {
            background: linear-gradient(90deg, #48bb78, #68d391);
        }
        
        .timeout-progress.warning {
            background: linear-gradient(90deg, #f6ad55, #fbbf24);
        }
        
        .timeout-progress.danger {
            background: linear-gradient(90deg, #fc8181, #f56565);
        }
        
        .countdown {
            font-size: 1.5em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #667eea;
            margin-top: 10px;
        }
        
        .countdown.warning {
            color: #f6ad55;
        }
        
        .countdown.danger {
            color: #fc8181;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .activity-log {
            max-height: 400px;
            overflow-y: auto;
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }
        
        .log-entry {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
            background: #0f172a;
            color: #e2e8f0;
            border-radius: 4px;
            animation: slideIn 0.3s;
        }
        
        .log-entry.activity {
            border-left-color: #f6ad55;
        }
        
        .log-entry.expired {
            border-left-color: #fc8181;
        }
        
        .log-entry.created {
            border-left-color: #48bb78;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .log-timestamp {
            color: #94a3b8;
            font-size: 0.85em;
        }
        
        .log-message {
            color: #e2e8f0;
            margin-top: 5px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-danger {
            background: #fc8181;
            color: white;
        }
        
        .btn-danger:hover {
            background: #f56565;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .test-controls {
            background: #fef5e7;
            border-left: 4px solid #f39c12;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .test-controls h3 {
            color: #d68910;
            margin-bottom: 15px;
        }
        
        .test-button {
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .test-button:hover {
            background: #d68910;
        }
        
        .info-box {
            background: #e6f3ff;
            border-left: 4px solid #4299e1;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .info-box h4 {
            color: #2c5282;
            margin-bottom: 10px;
        }
        
        .info-box ul {
            color: #2c5282;
            margin-left: 20px;
        }
        
        .info-box li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Real-Time Session Activity Tracking</h1>
            <p class="subtitle">
                <span class="status-indicator" id="connectionStatus"></span>
                <span id="connectionText">Connecting...</span>
            </p>
            <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                White Box Testing Dashboard - Demonstrates Session Inactivity Timeout Mechanism
            </p>
        </div>
        
        <div class="info-box">
            <h4>üìã How This Works (For White Box Testing)</h4>
            <ul>
                <li><strong>Session Activity Tracking:</strong> Each authenticated request updates the session's <code>lastActivity</code> timestamp</li>
                <li><strong>Automatic Extension:</strong> When activity is detected, <code>expiresAt</code> is extended by 15 minutes</li>
                <li><strong>Inactivity Timeout:</strong> Sessions inactive beyond 15 minutes are automatically invalidated</li>
                <li><strong>Real-Time Updates:</strong> This dashboard uses Server-Sent Events (SSE) to show live updates</li>
                <li><strong>Visual Indicators:</strong> Watch for highlighted updates when sessions are refreshed</li>
            </ul>
        </div>
        
        <div class="test-controls">
            <h3>üß™ Test Controls</h3>
            <p style="margin-bottom: 15px; color: #666;">Use these buttons to test session activity tracking:</p>
            <button class="test-button" onclick="makeTestRequest()">üì° Make Test API Request (Updates Session)</button>
            <button class="test-button" onclick="refreshSessions()">üîÑ Refresh Sessions Manually</button>
            <button class="test-button" onclick="clearActivityLog()">üóëÔ∏è Clear Activity Log</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Active Sessions</h3>
                <div class="value" id="activeSessions">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Activity Updates</h3>
                <div class="value" id="activityUpdates">0</div>
            </div>
            <div class="stat-card">
                <h3>Sessions Expiring Soon</h3>
                <div class="value" id="expiringSessions">0</div>
            </div>
            <div class="stat-card">
                <h3>Connection Status</h3>
                <div class="value" id="connectionStatusText" style="font-size: 1.2em;">-</div>
            </div>
        </div>
        
        <!-- Real-Time Sessions -->
        <div class="section">
            <h2>
                üì± Active Sessions (Real-Time)
                <button class="btn-primary" onclick="refreshSessions()">üîÑ Refresh</button>
            </h2>
            
            <div id="sessionsContainer">
                <div class="loading">Loading sessions...</div>
            </div>
        </div>
        
        <!-- Activity Log -->
        <div class="section">
            <h2>
                üìä Real-Time Activity Log
                <button class="btn-primary" onclick="clearActivityLog()">üóëÔ∏è Clear</button>
            </h2>
            
            <div class="activity-log" id="activityLog">
                <div style="color: #94a3b8; text-align: center; padding: 20px;">
                    Waiting for activity updates...
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
        
        if (!token) {
            document.body.innerHTML = `
                <div style="text-align: center; padding: 100px; background: white; border-radius: 12px; margin: 20px;">
                    <h1 style="color: #fc8181; margin-bottom: 20px;">‚ö†Ô∏è No Active Session</h1>
                    <p style="margin: 20px 0; color: #666;">Please login first to see real-time session tracking</p>
                    <a href="/admin-login.html" style="display: inline-block; padding: 15px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                        Login Now
                    </a>
                </div>
            `;
        }
        
        let eventSource = null;
        let activityUpdateCount = 0;
        let sessionsMap = new Map();
        
        function getDeviceIcon(deviceType) {
            switch(deviceType) {
                case 'Desktop': return 'üñ•Ô∏è';
                case 'Mobile': return 'üì±';
                case 'Tablet': return 'üì±';
                default: return 'üíª';
            }
        }
        
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return `${seconds} second${seconds !== 1 ? 's' : ''} ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            const days = Math.floor(hours / 24);
            return `${days} day${days !== 1 ? 's' : ''} ago`;
        }
        
        function formatCountdown(seconds) {
            if (seconds < 0) return 'EXPIRED';
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
        
        function addActivityLog(entry) {
            const logContainer = document.getElementById('activityLog');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${entry.type.replace('_', '-')}`;
            
            const timestamp = new Date(entry.timestamp).toLocaleTimeString();
            let message = entry.message || '';
            
            if (entry.type === 'activity_updated') {
                message = `üîÑ Activity Updated: ${entry.session.deviceType} - Last activity: ${formatTimeAgo(entry.newActivity)} - Session extended by 15 minutes`;
            } else if (entry.type === 'session_extended') {
                message = `‚è∞ Session Extended: ${entry.session.deviceType} - New expiry: ${new Date(entry.newExpiry).toLocaleString()}`;
            } else if (entry.type === 'session_expired') {
                message = `‚è±Ô∏è Session Expired: ${entry.session.deviceType} - Inactivity timeout reached`;
            } else if (entry.type === 'session_created') {
                message = `‚ú® New Session: ${entry.session.deviceType} - Created at ${new Date(entry.session.createdAt).toLocaleString()}`;
            } else if (entry.type === 'session_ended') {
                message = `üö´ Session Ended: Session ID ${entry.sessionId}`;
            }
            
            logEntry.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div class="log-message">${message}</div>
            `;
            
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
        
        function updateSessionsDisplay(sessions) {
            const container = document.getElementById('sessionsContainer');
            
            if (sessions.length === 0) {
                container.innerHTML = '<div class="loading">No active sessions found</div>';
                return;
            }
            
            let html = '';
            let expiringCount = 0;
            
            sessions.forEach(session => {
                const timeUntilExpiry = session.timeUntilExpiry || 0;
                const minutesUntilExpiry = session.minutesUntilExpiry || 0;
                const isExpiring = minutesUntilExpiry < 5 && minutesUntilExpiry > 0;
                const isExpired = timeUntilExpiry <= 0;
                
                if (isExpiring) expiringCount++;
                
                const progressPercent = Math.max(0, Math.min(100, (timeUntilExpiry / 900) * 100)); // 900 seconds = 15 minutes
                let progressClass = 'safe';
                if (progressPercent < 33) progressClass = 'danger';
                else if (progressPercent < 66) progressClass = 'warning';
                
                let cardClass = session.isCurrent ? 'current' : '';
                if (isExpired) cardClass += ' expired';
                else if (isExpiring) cardClass += ' expiring';
                
                const deviceIcon = getDeviceIcon(session.deviceType);
                const timeAgo = formatTimeAgo(session.lastActivity);
                const countdown = formatCountdown(timeUntilExpiry);
                let countdownClass = '';
                if (timeUntilExpiry < 300) countdownClass = 'danger';
                else if (timeUntilExpiry < 600) countdownClass = 'warning';
                
                html += `
                    <div class="session-card ${cardClass}" id="session-${session.id}">
                        <div class="session-header">
                            <div class="device-info">
                                <div class="device-icon">${deviceIcon}</div>
                                <div class="device-details">
                                    <h3>${session.deviceType} - ${session.browser}</h3>
                                    <p>${session.os}</p>
                                </div>
                            </div>
                            <span class="badge ${session.isCurrent ? 'badge-current' : 'badge-active'}">
                                ${session.isCurrent ? '‚úì Current Session' : 'Active'}
                            </span>
                        </div>
                        
                        <div class="session-details">
                            <div class="detail-item">
                                <span class="detail-label">IP Address</span>
                                <span class="detail-value">${session.ipAddress}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Created</span>
                                <span class="detail-value">${new Date(session.createdAt).toLocaleString()}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Last Activity</span>
                                <span class="detail-value" id="activity-${session.id}">${timeAgo}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Expires At</span>
                                <span class="detail-value" id="expiry-${session.id}">${new Date(session.expiresAt).toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="detail-item">
                            <span class="detail-label">Time Until Expiry</span>
                            <div class="countdown ${countdownClass}" id="countdown-${session.id}">${countdown}</div>
                            <div class="timeout-bar">
                                <div class="timeout-progress ${progressClass}" id="progress-${session.id}" style="width: ${progressPercent}%"></div>
                            </div>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                ${minutesUntilExpiry} of 15 minutes remaining
                            </small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('expiringSessions').textContent = expiringCount;
        }
        
        function startRealTimeTracking() {
            if (eventSource) {
                eventSource.close();
            }
            
            const url = `/api/sessions/realtime-track`;
            eventSource = new EventSource(url, {
                headers: {
                    'Authorization': `Bearer ${token}`
            }});
            
            // Note: EventSource doesn't support custom headers in browser
            // We'll need to use a workaround or modify the endpoint
            
            // Alternative: Use fetch with streaming or polling
            // For now, let's use polling approach
            startPolling();
        }
        
        function startPolling() {
            // Poll every 2 seconds for real-time updates
            setInterval(async () => {
                try {
                    const response = await fetch('/api/sessions/my-sessions', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Compare with previous state
                        const currentSessions = new Map();
                        data.data.forEach(session => {
                            currentSessions.set(session.id, session);
                            
                            // Check if activity was updated
                            const prevSession = sessionsMap.get(session.id);
                            if (prevSession && prevSession.lastActivity !== session.lastActivity) {
                                activityUpdateCount++;
                                document.getElementById('activityUpdates').textContent = activityUpdateCount;
                                
                                // Add to activity log
                                addActivityLog({
                                    type: 'activity_updated',
                                    session: session,
                                    previousActivity: prevSession.lastActivity,
                                    newActivity: session.lastActivity,
                                    timestamp: new Date().toISOString(),
                                    message: `Activity updated - session extended`
                                });
                                
                                // Highlight the session card
                                const card = document.getElementById(`session-${session.id}`);
                                if (card) {
                                    card.classList.add('activity-updated');
                                    setTimeout(() => {
                                        card.classList.remove('activity-updated');
                                    }, 1000);
                                    
                                    // Update activity display
                                    const activityEl = document.getElementById(`activity-${session.id}`);
                                    if (activityEl) {
                                        activityEl.textContent = formatTimeAgo(session.lastActivity);
                                        activityEl.classList.add('updated');
                                        setTimeout(() => {
                                            activityEl.classList.remove('updated');
                                        }, 2000);
                                    }
                                }
                            }
                            
                            // Update expiry display
                            const timeUntilExpiry = Math.max(0, Math.floor((new Date(session.expiresAt) - new Date()) / 1000));
                            const countdownEl = document.getElementById(`countdown-${session.id}`);
                            if (countdownEl) {
                                countdownEl.textContent = formatCountdown(timeUntilExpiry);
                                if (timeUntilExpiry < 300) countdownEl.className = 'countdown danger';
                                else if (timeUntilExpiry < 600) countdownEl.className = 'countdown warning';
                                else countdownEl.className = 'countdown';
                            }
                            
                            const progressEl = document.getElementById(`progress-${session.id}`);
                            if (progressEl) {
                                const progressPercent = Math.max(0, Math.min(100, (timeUntilExpiry / 900) * 100));
                                progressEl.style.width = `${progressPercent}%`;
                                if (progressPercent < 33) progressEl.className = 'timeout-progress danger';
                                else if (progressPercent < 66) progressEl.className = 'timeout-progress warning';
                                else progressEl.className = 'timeout-progress safe';
                            }
                        });
                        
                        sessionsMap = currentSessions;
                        
                        // Update display with enhanced data
                        const enhancedSessions = data.data.map(session => ({
                            ...session,
                            timeUntilExpiry: Math.max(0, Math.floor((new Date(session.expiresAt) - new Date()) / 1000)),
                            minutesUntilExpiry: Math.max(0, Math.floor((new Date(session.expiresAt) - new Date()) / 60000))
                        }));
                        
                        updateSessionsDisplay(enhancedSessions);
                        document.getElementById('activeSessions').textContent = enhancedSessions.length;
                        
                        updateConnectionStatus(true);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    updateConnectionStatus(false);
                }
            }, 2000);
            
            // Initial load
            refreshSessions();
        }
        
        async function refreshSessions() {
            try {
                const response = await fetch('/api/sessions/my-sessions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const enhancedSessions = data.data.map(session => ({
                        ...session,
                        timeUntilExpiry: Math.max(0, Math.floor((new Date(session.expiresAt) - new Date()) / 1000)),
                        minutesUntilExpiry: Math.max(0, Math.floor((new Date(session.expiresAt) - new Date()) / 60000))
                    }));
                    
                    updateSessionsDisplay(enhancedSessions);
                    document.getElementById('activeSessions').textContent = enhancedSessions.length;
                }
            } catch (error) {
                console.error('Error refreshing sessions:', error);
            }
        }
        
        async function makeTestRequest() {
            try {
                // Make a test API request that will trigger session activity update
                const response = await fetch('/api/sessions/session-stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    addActivityLog({
                        type: 'activity_updated',
                        timestamp: new Date().toISOString(),
                        message: 'üß™ Test API request sent - Session activity should update in 2 seconds'
                    });
                    
                    // Refresh after a short delay to see the update
                    setTimeout(() => {
                        refreshSessions();
                    }, 2500);
                }
            } catch (error) {
                console.error('Test request error:', error);
            }
        }
        
        function clearActivityLog() {
            document.getElementById('activityLog').innerHTML = `
                <div style="color: #94a3b8; text-align: center; padding: 20px;">
                    Activity log cleared. Waiting for new updates...
                </div>
            `;
        }
        
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            const statusTextCard = document.getElementById('connectionStatusText');
            
            if (connected) {
                statusIndicator.className = 'status-indicator connected';
                statusText.textContent = 'Connected - Real-time tracking active';
                statusTextCard.textContent = 'Connected';
            } else {
                statusIndicator.className = 'status-indicator disconnected';
                statusText.textContent = 'Disconnected';
                statusTextCard.textContent = 'Disconnected';
            }
        }
        
        // Update countdowns every second
        setInterval(() => {
            sessionsMap.forEach((session, id) => {
                const timeUntilExpiry = Math.max(0, Math.floor((new Date(session.expiresAt) - new Date()) / 1000));
                const countdownEl = document.getElementById(`countdown-${id}`);
                if (countdownEl) {
                    countdownEl.textContent = formatCountdown(timeUntilExpiry);
                    if (timeUntilExpiry < 300) countdownEl.className = 'countdown danger';
                    else if (timeUntilExpiry < 600) countdownEl.className = 'countdown warning';
                    else countdownEl.className = 'countdown';
                }
            });
        }, 1000);
        
        // Initialize
        window.onload = function() {
            updateConnectionStatus(true);
            startRealTimeTracking();
            
            // Add initial log entry
            addActivityLog({
                type: 'connected',
                timestamp: new Date().toISOString(),
                message: '‚úÖ Real-time session tracking initialized'
            });
        };
    </script>
</body>
</html>
